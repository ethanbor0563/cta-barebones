<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upcoming Trains</title>
<style>
body { margin:0; font-family: Arial,sans-serif; background:black; color:white; }
header { background-color: #1976d2; color:white; text-align:center; padding:1rem; font-size:2rem; }
.container { max-width:800px; margin:2rem auto; position:relative; height:400px; overflow:hidden; }
.card { position:absolute; left:0; width:95%; display:flex; justify-content:space-between; align-items:center; padding:1rem; color:white; border-radius:12px; transition: transform 1s ease, opacity 1s ease; }
.countdown { font-weight:bold; font-size:2rem; padding:0.3rem 0.6rem; border-radius:10px; min-width:60px; text-align:center; background:rgba(255,255,255,0.2); }
</style>
</head>
<body>
<header>Upcoming Trains</header>
<div class="container" id="train-list"></div>
<script>
const container = document.getElementById('train-list');
let trains = [];
let cardElements = [];
const cardHeight = 80;
const routeColors = {Red:'#d32f2f',Purple:'#6a1b9a',Blue:'#1976d2'};

function formatHM(d){
  const h = d.getHours();
  const h12 = ((h + 11) % 12) + 1; // 1..12
  const mm = d.getMinutes().toString().padStart(2,'0');
  return `${h12}:${mm}`;
}

function fetchTrains(){
    fetch('/api/trains')
    .then(r=>r.json())
    .then(data=>{
        const newTrains = data.map(t=>({ id: t.train_id, route: t.route, dest: t.dest, eta: new Date(t.eta_iso) }));

        // Detect if the previously-first train has disappeared from API
        const prevFirstId = trains.length ? trains[0].id : null;
        const stillHasPrevFirst = prevFirstId ? newTrains.some(nt => nt.id === prevFirstId) : true;

        if(prevFirstId && !stillHasPrevFirst && cardElements.length){
            // Trigger slide ONLY when the old first train is gone
            slideTrain();
            // Do not overwrite trains yet; slideTrain handles data fetch/insert and the next minute refresh will sync
        } else {
            // Normal refresh: update list and re-render without slide
            trains = newTrains;
            renderCards();
        }
    });
}

function renderCards(){
    container.innerHTML='';
    cardElements=[];
    trains.forEach((t,i)=>{
        const card = document.createElement('div');
        card.className='card';
        if(t.route == "P") {
			card.style.backgroundColor=routeColors['Purple']||'#1976d2';
		} else {
			card.style.backgroundColor=routeColors[t.route]||'#1976d2';
		}
        card.style.transform=`translateY(${i*cardHeight}px)`;
        card.style.opacity='1';
        card.innerHTML=`<div>${t.route} Line - ${t.dest}</div><div class='countdown'></div>`;
        container.appendChild(card);
        cardElements.push(card);
    });
}

function updateCountdowns(){
    const now = new Date();
    cardElements.forEach((card,i)=>{
        const eta=trains[i]?.eta; // guard in case slide is mid-flight
        if(!eta) return;
        let diff=Math.max(0,Math.floor((eta-now)/1000));
        const m=Math.floor(diff/60);
        const s=diff%60;
        card.querySelector('.countdown').innerText=`${m}:${s.toString().padStart(2,'0')}  ${formatHM(eta)}`;
    });
}

// === DO NOT MODIFY: original slide mechanism kept intact ===
function slideTrain(){
    if(cardElements.length===0) return;
    const firstCard=cardElements.shift();
    firstCard.style.transform=`translateY(-120%)`;
    firstCard.style.opacity='0';
    trains.shift();

    cardElements.forEach((card,i)=>{
        card.style.transform=`translateY(${i*cardHeight}px)`;
    });

    setTimeout(()=>{
        container.removeChild(firstCard);
        fetch('/api/trains').then(r=>r.json()).then(data=>{
            const newTrainRaw = data[0];
            if(!newTrainRaw) return; // safety
            const newTrain = { id: newTrainRaw.train_id, route: newTrainRaw.route, dest: newTrainRaw.dest, eta: new Date(newTrainRaw.eta_iso) };
            trains.push(newTrain);
            const newCard = document.createElement('div');
            newCard.className = 'card';
            if(newTrain.route == "P") {
				newCard.style.backgroundColor=routeColors['Purple']||'#1976d2';
			} else {
				card.style.backgroundColor=routeColors[t.route]||'#1976d2';
			}
            newCard.style.transform = `translateY(${cardElements.length*cardHeight + cardHeight}px)`;
            newCard.style.opacity = '1';
            newCard.innerHTML = `<div>${newTrain.route} Line - ${newTrain.dest}</div><div class='countdown'></div>`;
            container.appendChild(newCard);
            requestAnimationFrame(()=>{
                newCard.style.transform = `translateY(${cardElements.length*cardHeight}px)`;
            });
            cardElements.push(newCard);
        });
    },1000);
}

fetchTrains();
setInterval(fetchTrains,60000);
setInterval(updateCountdowns,1000);
// Removed periodic slide trigger: only slide when a train disappears from API
</script>
</body>
</html>
