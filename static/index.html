<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CTA Train Tracker</title>
<style>
body { margin:0; font-family: sans-serif; background:black; color:white; }
header { background:#007bff; color:white; text-align:center; font-size:3em; padding:10px; }
#train-container { padding: 20px; display:flex; flex-direction:column; gap:10px; overflow:hidden; }
.train-card { display:flex; justify-content:space-between; padding:20px; border-radius:12px; color:black; transition: transform 1s, opacity 1s; }
.train-left { flex:4; font-size:2em; }
.train-countdown, .train-eta { flex:1; text-align:center; font-size:2em; background:white; border-radius:8px; padding:5px; }
</style>
</head>
<body>
<header>Upcoming Trains</header>
<div id="train-container"></div>
<script>
let trains = [];

function fetchTrains(){
    fetch('/api/trains')
        .then(r=>r.json())
        .then(data=>{
            trains = data.map(t => ({
                ...t,
                eta: new Date(t.eta_iso)
            }));
            updateUI();
        });
}

function updateUI(){
    const container = document.getElementById('train-container');
    container.innerHTML = '';
    trains.forEach(t => {
        const card = document.createElement('div');
        card.className = 'train-card';
        card.style.background = routeColor(t.route);
        card.innerHTML = `
            <div class="train-left">${t.route} to ${t.dest}</div>
            <div class="train-countdown">in 0:00</div>
            <div class="train-eta">${formatTime(t.eta)}</div>
        `;
        container.appendChild(card);
    });
}

function routeColor(route){
    const map = {"Red":"#FF0000","Blue":"#0000FF","Brn":"#A52A2A","G":"#00FF00","Org":"#FFA500","Pink":"#FF69B4","P":"#800080","Y":"#FFFF00","Purple":"#800080"};
    return map[route]||'#FFFFFF';
}

function formatTime(d){return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});}

function updateCountdowns(){
    const now = new Date();
    const container = document.getElementById('train-container');
    Array.from(container.children).forEach((card,i)=>{
        const eta = trains[i].eta;
        let diff = Math.max(0, (eta-now)/1000);
        let m = Math.floor(diff/60);
        let s = Math.floor(diff%60);
        card.querySelector('.train-countdown').textContent = `in ${m}:${s.toString().padStart(2,'0')}`;
    });
}

fetchTrains();
setInterval(fetchTrains, 60000); // refresh every minute
setInterval(updateCountdowns, 1000); // update countdowns every second
</script>
</body>
</html>
