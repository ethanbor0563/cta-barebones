<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upcoming Trains</title>
<style>
body { margin:0; font-family: Arial,sans-serif; background:black; color:white; }
header { background-color: #1976d2; color:white; text-align:center; padding:1rem; font-size:2rem; }
.container { max-width:800px; margin:2rem auto; position:relative; height:400px; overflow:hidden; }
.card { position:absolute; left:0; width:95%; display:flex; justify-content:space-between; align-items:center; padding:1rem; color:white; border-radius:12px; transition: transform 1s ease, opacity 1s ease; }
.countdown { font-weight:bold; font-size:1.2rem; padding:0.3rem 0.6rem; border-radius:10px; min-width:100px; text-align:center; background:rgba(255,255,255,0.2); }
</style>
</head>
<body>
<header>Upcoming Trains</header>
<div class="container" id="train-list"></div>
<script>
const container = document.getElementById('train-list');
let trains = [];
let cardElements = {};
const cardHeight = 80;
const routeColors = {Red:'#d32f2f',Purple:'#6a1b9a',Blue:'#1976d2'};

function fetchTrains(){
    fetch('/api/trains')
    .then(r=>r.json())
    .then(data=>{
        const newTrains = data.map(t=>({ ...t, eta: new Date(t.eta_iso) }));
        updateCards(newTrains);
    });
}

function updateCards(newTrains){
    // Find trains that disappeared
    const oldIds = trains.map(t=>t.id);
    const newIds = newTrains.map(t=>t.id);

    oldIds.forEach(id => {
        if(!newIds.includes(id)){
            // Slide out train that disappeared
            const card = cardElements[id];
            if(card){
                card.style.transform = `translateY(-120%)`;
                card.style.opacity = '0';
                setTimeout(()=>{
                    if(card.parentNode){
                        container.removeChild(card);
                    }
                    delete cardElements[id];
                },1000);
            }
        }
    });

    trains = newTrains;

    // Render/update cards
    trains.forEach((t,i)=>{
        let card = cardElements[t.id];
        if(!card){
            card = document.createElement('div');
            card.className='card';
            card.style.backgroundColor=routeColors[t.route]||'#1976d2';
            card.innerHTML=`<div>${t.route} Line - ${t.dest}</div><div class='countdown'></div>`;
            container.appendChild(card);
            cardElements[t.id] = card;
        }
        card.style.transform = `translateY(${i*cardHeight}px)`;
        card.style.opacity = '1';
    });
}

function updateCountdowns(){
    const now = new Date();
    trains.forEach(t=>{
        const card = cardElements[t.id];
        if(card){
            let diff=Math.max(0,Math.floor((t.eta-now)/1000));
            const h=Math.floor(diff/3600);
            const m=Math.floor((diff%3600)/60);
            const s=diff%60;
            const etaStr = `${t.eta.getHours()}:${t.eta.getMinutes().toString().padStart(2,'0')}`;
            card.querySelector('.countdown').innerText=`${h>0? h+':'+m.toString().padStart(2,'0'):m}:${s.toString().padStart(2,'0')} (ETA ${etaStr})`;
        }
    });
}

fetchTrains();
setInterval(fetchTrains,60000);
setInterval(updateCountdowns,1000);
</script>
</body>
</html>
