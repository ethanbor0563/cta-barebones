<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upcoming Trains</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
    }
    header {
        background-color: #1976d2;
        color: white;
        text-align: center;
        padding: 1rem;
        font-size: 1.5rem;
    }
    .container {
        max-width: 800px;
        margin: 2rem auto;
        position: relative;
        height: 800px;
        overflow: hidden;
    }
    .card {
        position: absolute;
        left: 0;
        width: 90%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        color: white;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transform: translateY(100%);
        opacity: 0;
        transition: transform 1s ease, opacity 1s ease;
    }
    .countdown {
        font-weight: bold;
        font-size: 1.2rem;
        padding: 0.3rem 0.6rem;
        border-radius: 10px;
        min-width: 60px;
        text-align: center;
    }
</style>
</head>
<body>
<header>Upcoming Trains</header>
<div class="container" id="train-list"></div>
<script>
const container = document.getElementById('train-list');
let trains = [];
let cardElements = [];
const cardHeight = 80;
const routeColors = {Red:'#d32f2f',Purple:'#6a1b9a',Blue:'#1976d2'};

function fetchTrains(){
    fetch('/api/trains')
    .then(r=>r.json())
    .then(data=>{
        const newTrains = data.map(t=>({ ...t, eta: new Date(t.eta_iso) }));

        // Slide off cards no longer in API
        cardElements = cardElements.filter((card,i)=>{
            const exists = newTrains.find(t=>t.train_id===trains[i]?.train_id);
            if(!exists){
                card.style.transform=`translateY(-${cardHeight*1.5}px)`;
                card.style.opacity='0';
                setTimeout(()=>container.removeChild(card),1000);
            }
            return exists;
        });

        trains = newTrains;
        renderNewCards();
    });
}

function renderNewCards(){
    trains.forEach((t,i)=>{
        if(!cardElements[i]){
            const card = document.createElement('div');
            card.className='card';
            card.style.backgroundColor=routeColors[t.route]||'#1976d2';
            card.style.transform=`translateY(${i*cardHeight + cardHeight}px)`; // start below last
            card.style.opacity='0';
            card.innerHTML=`<div class='card-section'>${t.route} Line - ${t.dest}</div>
                            <div class='card-section'>
                                <div class='countdown'></div>
                                <div class='eta'>${t.eta.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            </div>`;
            container.appendChild(card);
            cardElements[i]=card;

            // Animate into position
            requestAnimationFrame(()=>{
                card.style.transform=`translateY(${i*cardHeight}px)`;
                card.style.opacity='1';
            });
        } else {
            // Slide existing cards to new position
            requestAnimationFrame(()=>{
                cardElements[i].style.transform=`translateY(${i*cardHeight}px)`;
            });
        }
    });
}

function updateCountdowns(){
    const now = new Date();
    cardElements.forEach((card,i)=>{
        const eta=trains[i].eta;
        let diff=Math.max(0,Math.floor((eta-now)/1000));
        const m=Math.floor(diff/60);
        const s=diff%60;
        card.querySelector('.countdown').innerText=`${m}:${s.toString().padStart(2,'0')}`;
    });
}

fetchTrains();
setInterval(fetchTrains,60000);
setInterval(updateCountdowns,1000);
</script>
</body>
</html>
